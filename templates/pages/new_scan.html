{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard - FloraScan</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="{% static 'css/style.css' %}">

</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <ul>
            <li><a href="{% url 'dashboard' %}"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
            <li><a href="{% url 'new_scan' %}"><i class="fas fa-camera"></i><span>New Scan</span></a></li>
            <li><a href="{% url 'history' %}"><i class="fas fa-history"></i><span>History</span></a></li>
            <li><a href="{% url 'profile' %}"><i class="fas fa-user"></i><span>Profile</span></a></li>
            <li><a href="{% url 'settings' %}"><i class="fas fa-cog"></i><span>Settings</span></a></li>
        </ul>
    </div>

    <!-- Header -->
    <header>
        <div class="logo">
            <button class="toggle-btn" id="toggle-btn"><i class="fas fa-bars"></i></button>
            ðŸŒ± FloraScan
        </div>
        <div class="profile">
            <a href="{% url 'logout' %}">Logout</a>
        </div>
    </header>

    <!-- Main -->
    <main>
        <h2 style="color:black;">Start a New Plant Scan</h2>

        <div class="scan-section">
            <p>Upload an image or use your camera to capture a leaf</p>
            <label class="upload-btn">
                Upload Image
                <input type="file" name="plant_image" accept="image/*">
            </label>
            <button class="upload-btn" id="capture-camera-btn">Capture from Camera</button>
            <div class="camera-section" style="display:none; text-align:center;">
                <video id="camera" autoplay playsinline></video>
                <br>
                <button id="take-photo-btn" class="upload-btn">ðŸ“¸ Take Photo</button>
            </div>

            <canvas id="photo-canvas" style="display:none;"></canvas>
            <div id="image-preview" style="margin-top: 15px; text-align:center;">
                <img id="preview-img" src="" alt="Preview" style="max-width:300px; border-radius:8px; display:none;"/>
            </div>

            <div class="loader" id="loader"></div>
        </div>

        <div class="results" id="results">
            <h3>Prediction Result</h3>
            <p><strong>Disease:</strong> --</p>
            <p><strong>Confidence:</strong> --</p>
            <p><strong>Treatment:</strong> --</p>
        </div>

        <div class="disease-info">
            <h3>Common Plant Diseases</h3>
            <p>Here you can provide detailed descriptions of common plant diseases, symptoms, and treatments.</p>
        </div>

        <button class="pdf-btn">Download PDF Report</button>

    </main>

    <footer>
        &copy; {{ now.year }} FloraScan. All rights reserved.
    </footer>


<script>
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggle-btn');
    toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
    });
    const captureBtn = document.getElementById('capture-camera-btn');
    const cameraSection = document.querySelector('.camera-section');
    const video = document.getElementById('camera');
    const takePhotoBtn = document.getElementById('take-photo-btn');
    const canvas = document.getElementById('photo-canvas');

    const fileInput = document.querySelector('input[name="plant_image"]');
    const previewImg = document.getElementById('preview-img');

    let cameraStream = null;

    // Show preview when uploading from file input
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            previewImg.src = URL.createObjectURL(this.files[0]);
            previewImg.style.display = 'block';
        }
    });

    // Open camera
    captureBtn.addEventListener('click', () => {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                cameraStream = stream;
                cameraSection.style.display = 'block';
                video.srcObject = stream;
            })
            .catch(err => {
                alert('Camera access denied or not available.');
                console.error(err);
            });
    });

    // Capture image from camera
    takePhotoBtn.addEventListener('click', () => {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Stop camera
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }

        // Convert to blob & show preview
        canvas.toBlob(blob => {
            const file = new File([blob], "captured_image.png", { type: "image/png" });

            // Put into file input for form submission
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;

            // Show preview from canvas
            previewImg.src = URL.createObjectURL(file);
            previewImg.style.display = 'block';
        }, "image/png");
    });
</script>

</body>
</html>
